name: Security Scan

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  scan-secrets:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Full history for secret scanning
      
      - name: Check for secrets
        run: |
          # Check for common secret patterns
          if git log --all -p | grep -qiE "(password|secret|token|key|private_key|access_token)\s*[:=]\s*[^\s\"'`]{20,}"; then
            echo "❌ ERROR: Potential secrets found in Git history"
            echo "   Run scripts/purge-git-history.sh to clean history"
            exit 1
          fi
          
          # Check for real IP addresses (excluding localhost and example ranges)
          if git log --all -p | grep -qE "\b(?!127\.0\.0\.1|10\.10\.0\.|192\.168\.|172\.(1[6-9]|2[0-9]|3[01])\.|localhost)(\d{1,3}\.){3}\d{1,3}\b"; then
            echo "❌ ERROR: Real IP addresses found in Git history"
            echo "   Run scripts/purge-git-history.sh to clean history"
            exit 1
          fi
          
          echo "✅ No secrets detected in Git history"
      
      - name: Check staged files
        run: |
          # Check for .env files
          if git diff --cached --name-only | grep -qE "\.env$"; then
            echo "❌ ERROR: .env file detected in staged changes"
            exit 1
          fi
          
          # Check for private keys
          if git diff --cached --name-only | grep -qE "\.(key|pem|p12|pfx)$|.*_rsa$|deploy_key"; then
            echo "❌ ERROR: Private key file detected in staged changes"
            exit 1
          fi
          
          echo "✅ No sensitive files in staged changes"




